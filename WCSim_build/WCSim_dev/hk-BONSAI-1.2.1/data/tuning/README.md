# How to make BONSAI tuning file.

First version by T. Yano, 1st June 2020.

1. Make a 10 MeV electron simulation with the detector simulation you are tuning for.
   By generating e- uniformly distributed inside the Fiducial Volume.
   Dark noise should be turned off for this tuning.

   One way of doing this is in WCSim is by using a `.kin` file input
   `python $WCSIMDIR/sample-root-scripts/MakeKin.py --detector GEOMETRY --direction 4pi --vertex random --energy 10 --type e- --npart 50000`
   where `GEOMETRY` is the geometry name you're using.
   Make sure to confirm that it generate particles in the fiducial volume you're interested in:
   * `MakeKin.py --vertex random` generates particles in the volume defined by the `detectors` dictionary at the top of the file, 20 cm shorter in each dimension
   * The simulated inner detector dimensions for your geometry are available in the relevant part of `$WCSIMDIR/src/WCSimDetectorConfigs.cc`
     * i.e. `WCIDDiameter` and `WCIDHeight` for the method called by your geometry

   It is important to make sure digitised hit times are relative to a fixed offset. Therefore
   * All electrons should be simulated at the same time
   * The NoTrigger trigger should be used.
     *  This is because digit time is defined as `G4double digihittime = -triggertime + WCSimWCTriggerBase::offset + digit_time;`, therefore the trigger time can cause an arbitrary spread in the tuning histograms.
     * If for some reason the NoTrigger trigger cannot be used, you can change the digit time definition in `$WCSIMDIR/src/WCSimWCTrigger.cc`

2. Make a T-TOF distribution using 1.
   Please use light speed of `21.58333 cm/ns`, which is the group speed of light in pure water.
   The range of time is from -50 to 250ns here, divided by 750 bins. The binning can be changed if required (binning changes are automatically picked up by the following steps)

   `rootwc -b -q $BONSAIDIR/data/tuning/analysis_wcsim/generate_t_minus_tof.C+'("/path/to/wcsim/file.root",false)'`

   The output will be a `.root` file with the T-TOF distribution, as well as a `.pdf` of the distribution

3. Fit the T-TOF distribution above, with Gaussian + exponential distribution.

   `rootwc $BONSAIDIR/data/tuning/analysis_wcsim/analysis.C+'("/path/to/tof/file.root")'`

   Note that you may have to finese the fit a bit e.g. choosing different starting values, etc.

   The sample root macro will out put some C language code e.g.:
   ```C++
   dx=(i*TBIN/3.62877 );
   if (x>-1.5)
	dhisto[i+nneg]+=1*exp(-0.5*dx*dx);
   if (x<=-1.5)
   {
	dhisto[i+nneg]+=0.0152847*exp(0.0522206*x);
	dhisto[i+nneg]+=1.42029*exp(0.386937*x);
	dhisto[i+nneg]+=0.0287887*exp(0.0135527*x);
   }
   ```

    A `.pdf` of the distribution, along with the fit result, will also be output

4. Generate the likelihood binary. 
   Put them into `create_like.cc` as a new entry (i.e. new `j` value) unless you're updating an old tune

   ```C++
   /*SK 20 PMT*/
   else if (j==4){
	std::cout << "/*SK 20 PMT*/" << std::endl;
	dx=(i*TBIN/3.62877 );
	if (x>-1.5)
		dhisto[i+nneg]+=1*exp(-0.5*dx*dx);
	if (x<=-1.5)
	{
		dhisto[i+nneg]+=0.0152849*exp(0.0522208*x);
		dhisto[i+nneg]+=1.4203*exp(0.386938*x);
		dhisto[i+nneg]+=0.0287886*exp(0.0135527*x);
	}
   }
   ```

   Then run as
   ```bash
   make;
   $BONSAIDIR/data/tuning/create_like $BONSAIDIR/data/likelihood_binary/output_filename.bin <geometry int code>;
   ```

5. Ensure that your new tune is better than the previous version. If it isn't, return to 3 and improve the fit

   Run this with this with both the old and new tunes in `$BONSAIDIR/data/like.bin`, on the same WCSim events, and compare the output
   ```bash
   rootbonsai -b -q $BONSAIDIR/sample-root-scripts/sample_bonsai.C+'("/path/to/wcsim/file.root")'
   ```

6. Add the new `.bin` file to your fork of the hk-BONSAI repository, and submit a pull request

## Files

| File             | Description |
| ---------------- | ----------- |
| `analysis_wcsim/generate_t_minus_tof.C` | Create T-TOF histogram from the WCSim file |
| `analysis_wcsim/analysis.C` | ROOT macro sample to fit the T-TOF distributions |
| `run.sh`         | Bash script to generate existing likelihood binaries |
| `create_like.cc` | Source code to generate likelihood binary |
| `show_like.cc`   | Source code to show likelihood binary |
| `binfile.cc`, `binfile.h` | Classes used by `{show,create}_like` |
| `Makefile`       | Compiles `{show,create}_like` |

## Known issues

1. T-TOF distribution generated by WCSim can have a peak at non-0 value.
   The discrepancy from 0 ns is small as ~0.7ns.
   In current tuning, this is ignored.
   Though, this may affect to reconstruction.

   Looking at the code, hit time is defined by the time hitting the glass surface (`WCSimConstructPMT.cc`).
   But to calculate T-TOF, the geometry we use is the the PMT position on the detector wall.
   (In SK case, we consider the time difference between hit time on the glass surface and real signal output.)
   This will result the peak at non-0. This effect may be taken into account, for better vertex reconstruction.

2. We have another tuning file, `$BONSAIDIR/data/fit_param.dat`
   There's some parameters to tune, but currently we're using same set up as SK.
